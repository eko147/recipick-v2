"use strict";

!(function () {
  // ====================================
  // 드롭다운 관련 초기화
  // ====================================
  document
    .querySelectorAll(".dropdown-menu a.dropdown-toggle")
    .forEach((dropdownToggle) => {
      dropdownToggle.addEventListener("click", function (event) {
        const submenu = this.nextElementSibling;

        if (!submenu.classList.contains("show")) {
          this.closest(".dropdown-menu")
            .querySelectorAll(".show")
            .forEach((el) => el.classList.remove("show"));
        }

        submenu.classList.toggle("show");

        const parentDropdown = this.closest("li.nav-item.dropdown.show");
        if (parentDropdown) {
          parentDropdown.addEventListener("hidden.bs.dropdown", () => {
            document
              .querySelectorAll(".dropdown-submenu .show")
              .forEach((el) => el.classList.remove("show"));
          });
        }

        event.stopPropagation();
      });
    });

  // ====================================
  // Bootstrap 툴팁 및 팝오버 초기화
  // ====================================
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach((tooltip) => {
    new bootstrap.Tooltip(tooltip);
  });

  document.querySelectorAll('[data-bs-toggle="popover"]').forEach((popover) => {
    new bootstrap.Popover(popover);
  });

  // ====================================
  // 입력 그룹 버튼 (증가/감소) 처리
  // ====================================
  document.querySelectorAll(".input-group").forEach((group) => {
    group.addEventListener("click", (event) => {
      if (event.target.classList.contains("button-plus")) {
        adjustInputValue(event, 1);
      } else if (event.target.classList.contains("button-minus")) {
        adjustInputValue(event, -1);
      }
    });
  });

  function adjustInputValue(event, increment) {
    event.preventDefault();
    const button = event.target;
    const fieldName = button.getAttribute("data-field");
    const input = button
      .closest("div")
      .querySelector(`input[name="${fieldName}"]`);
    const currentValue = parseInt(input.value, 10) || 0;

    if (increment < 0 && currentValue <= 0) return;

    input.value = currentValue + increment;
  }

  // ====================================
  // 별점 컴포넌트 초기화
  // ====================================
  document.querySelectorAll(".rater").forEach((rater) => {
    raterJs({
      starSize: 20,
      element: rater,
      rateCallback: function (rating, done) {
        this.setRating(rating);
        done();
      },
    });
  });

  // ====================================
  // 사이드바 내비게이션 클릭 처리
  // ====================================
  const sidebarLinks = document.querySelectorAll(".sidebar-nav-fixed a");
  sidebarLinks.forEach((link) => {
    link.addEventListener("click", (event) => {
      if (
        location.pathname.replace(/^\//, "") ===
          link.pathname.replace(/^\//, "") &&
        location.hostname === link.hostname
      ) {
        const target = document.querySelector(link.hash);
        if (target) {
          event.preventDefault();
          window.scrollTo({ top: target.offsetTop - 90, behavior: "smooth" });
          target.setAttribute("tabindex", "-1");
          target.focus();
        }
      }

      sidebarLinks.forEach((el) => el.classList.remove("active"));
      link.classList.add("active");
    });
  });

  // ====================================
  // Flatpickr 초기화
  // ====================================
  document.querySelectorAll(".flatpickr").forEach((picker) => {
    flatpickr(picker, {
      disableMobile: true,
      allowInput: true,
      dateFormat: "d/m/Y",
    });
  });

  // ====================================
  // Check All 기능
  // ====================================
  const checkAll = document.querySelector("#checkAll");
  if (checkAll) {
    checkAll.addEventListener("click", () => {
      document
        .querySelectorAll('input[type="checkbox"]')
        .forEach((checkbox) => {
          if (checkbox !== checkAll) {
            checkbox.checked = checkAll.checked;
          }
        });
    });
  }

  // ====================================
  // 알림 메시지 처리
  // ====================================
  const alertPlaceholder = document.querySelector("#liveAlertPlaceholder");
  const alertButton = document.querySelector("#liveAlertBtn");
  if (alertPlaceholder && alertButton) {
    alertButton.addEventListener("click", () => {
      showAlert("Nice, you triggered this alert message!", "success");
    });
  }

  function showAlert(message, type) {
    const alertDiv = document.createElement("div");
    alertDiv.innerHTML = `
      <div class="alert alert-${type} alert-dismissible" role="alert">
        <div>${message}</div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>`;
    alertPlaceholder.append(alertDiv);
  }

  // ====================================
  // 파일 업로드 및 이미지 미리보기
  // ====================================
  document.querySelectorAll(".file-input").forEach((fileInput) => {
    fileInput.addEventListener("change", () => {
      const previewImage = fileInput
        .closest(".form-group")
        .querySelector(".image");
      const reader = new FileReader();
      reader.onload = (event) => {
        previewImage.setAttribute("src", event.target.result);
      };
      reader.readAsDataURL(fileInput.files[0]);
    });
  });

  // ====================================
  // 태그 입력 초기화
  // ====================================
  const tagsInput = document.querySelector("input[name=tags]");
  if (tagsInput) {
    new Tagify(tagsInput);
  }
})();
